
{% extends '/core/home.jinja2' %}

{% block content %}
    <section class="upload container">
        {# FIXME: maybe this can be improved #}
        <link rel="stylesheet" href="/static/css/upload.css">

        <h2>{{_('Edit object')}}</h2>
        
        <section class="upload-form">
            <div class="container">
                <form name="upload-form" method="post" enctype="multipart/form-data">
                    {{ csrf_input }}
                        <h3>{{_("Edit Object's title")}}</h3>
                        {{ form.visible_fields()[2] }}
                        {{ form.visible_fields()[2].errors }}
                    <p class="upload-field" id="source-field">
                        <h3>{{_("Choose Object")}}</h3>                                                     
                        {{ form.visible_fields()[0] }}
                        {{ form.visible_fields()[0].errors }}
                    </p>

                    {# TO BE IMPLEMENTED - SLIDERS TO CHOOSE OBJECT SCALE AND POSITION #}
                    {# <input ... type = 'range'... #}
                    <div id="edit_object_attributes">

                        <h2 id="scaleTitle" class="tipTrigger">{{_("Adjust scales")}}</h2>
                        <div id="tip1"> 
                            {{_("The scale must be adjusted in relation to the size of the marker on the screen. 
                            In case of a decimal number, use a dot. E.g. scale = 2.5 => 2.5x the size of the marker.")}}
                        </div>
                        <input id="scale" class="trigger-change-value" value ="{{ model.fullscale }}">

                        <h2 id="positionTitle" class="tipTrigger">{{_("Adjust position")}}</h2>
                        <div id="tip2">
                            {{_("Position should be adjusted relative to the Marker's size on the screen. 
                            If horizontal position is 2, the center of the Object will be in a distance 2 
                            times the size of its Marker's side to the right. If it's -1, it will be shown to the left.")}}
                        </div>
                        <h3>Horizontal:</h3>
                        <input id="X-position" class="trigger-change-value" value ="{{ model.xposition }}">
                        <h3>Vertical:</h3>
                        <input id="Y-position" class="trigger-change-value" value ="{{ model.yposition }}">                     

                        {{ form.hidden_fields()[0] }}
                        {{ form.hidden_fields()[0].errors }}
                        {{ form.hidden_fields()[1] }}
                        {{ form.hidden_fields()[1].errors }}
                        {{ form.hidden_fields()[2] }}
                        {{ form.hidden_fields()[2].errors }}

                    </div>
    
                    {# <p class="form-options">

                        <input id="author-chk" type="checkbox" name="author" value="1">
                        {% if form_type == 'marker' %}
                            {{ _("I'm this Marker author") }}
                        {% elif form_type == 'object' %}
                            {{ _("I'm this Object author") }}
                        {% endif %}
                        
                    </p>#}
                    <p class="upload-field" id="author-field" hidden>
                        {{ form.visible_fields()[1] }}
                        {{ form.visible_fields()[1].errors }}
                    </p>
                    {#<div class="form-options">
                        <p>
                            <input id="agreement-chk" type="checkbox" name="agreement" value="1">
                            {{ _('I agree to have this content under <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC BY-SA 4.0</a> and I\'m aware that it can\'t be removed after other people are using it.') }}
                        </p>
                    </div> #}
                    <input onclick="updateValues()" class="submit-btn" type="submit" value="{{ _('Submit') }}"/>
                </form>
            </div>
        </section>

        <script>

            /*$('#agreement-chk').click(function(){
                if($(this).prop('checked') == true){
                    $('input[type="submit"]').prop('disabled', false);
                }else{
                    $('input[type="submit"]').prop('disabled', true);
                }
            });

            $('#author-chk').click(function(){
                if($(this).prop('checked') == true){
                    let user = $('div.welcome > p > a')[0].innerText;
                    console.log(user);
                    $('#author-field > input').val(user);
                    $('#author-field > input').prop('readonly', true);
                }else{
                    $('#author-field > input').prop('readonly', false);
                    $('#author-field > input').val("");
                }
            });*/

            $("#id_source").change(
                function(e) {               
                    for (var i = 0; i < e.originalEvent.srcElement.files.length; i++) {                  
                        var file = e.originalEvent.srcElement.files[i];
            
                        var image_preview = document.createElement("img");
                        var reader = new FileReader();
                        reader.onloadend = function() {
                            image_preview.src = reader.result;
                            image_preview.id = "img-preview";
                            image_preview.hidden = "hidden";
                        }
                        reader.readAsDataURL(file);            
                        $("input").after(image_preview); //make preview image of the object/marker show  
                    }                
                }
            );

            
            function updateValues(){
                var image_preview = document.querySelector('#img-preview');
                if (image_preview){
                    var high = image_preview.naturalHeight;
                    var wide = image_preview.naturalWidth;

                    if(high >= wide){
                        var yprop = 1
                        var xprop = (wide*1.0)/high;
                    }else{
                        var xprop = 1
                        var yprop = (high*1.0)/wide;
                    }
                }
                else{
                    xprop = {{ model.xproportion }};
                    yprop = {{ model.yproportion }};
                }

                var scal = document.getElementById('scale').value;
                var xpos = document.getElementById('X-position').value;
                var ypos = document.getElementById('Y-position').value;

                var scl = scal*xprop + " " + scal*yprop;
                var rot = "270 0 0";
                var pos = xpos + " " + ypos + " 0"; //messing with the Z gives some really weird things
 
                $('#id_scale').val(scl); 
                $('#id_rotation').val(rot);
                $('#id_position').val(pos);
            }
                            
        </script>
    </section>
{% endblock %}